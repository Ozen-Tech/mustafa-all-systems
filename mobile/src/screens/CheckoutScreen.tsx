import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  Alert,
  ActivityIndicator,
  ScrollView,
  Image,
} from 'react-native';
import * as ImagePicker from 'expo-image-picker';
import * as FileSystem from 'expo-file-system';
import { useNavigation, NavigationProp } from '@react-navigation/native';
import { visitService } from '../services/visitService';
import { photoService } from '../services/photoService';
import { industryService } from '../services/industryService';
import { colors, theme } from '../styles/theme';
import Button from '../components/ui/Button';
import Card from '../components/ui/Card';
import { requestForegroundPermissions, getCurrentPosition, LocationObject } from '../utils/locationHelper';

interface Visit {
  id: string;
  store: {
    id: string;
    name: string;
    address: string;
  };
  checkInAt: string;
}


type RootStackParamList = {
  Home: undefined;
};

export default function CheckoutScreen({ route }: any) {
  const navigation = useNavigation<NavigationProp<RootStackParamList>>();
  const { visit: initialVisit } = route.params || {};
  const [visit, setVisit] = useState<Visit | null>(initialVisit);
  const [location, setLocation] = useState<LocationObject | null>(null);
  const [loading, setLoading] = useState(false);
  const [photoUri, setPhotoUri] = useState<string | null>(null);
  const [showPreview, setShowPreview] = useState(false);
  const [checkInTime, setCheckInTime] = useState<Date | null>(null);
  const [cameraPermission, setCameraPermission] = useState<boolean | null>(null);
  const [locationLoading, setLocationLoading] = useState(false);

  useEffect(() => {
    requestLocationPermission();
    requestCameraPermission();
    if (visit?.checkInAt) {
      setCheckInTime(new Date(visit.checkInAt));
    }
  }, []);

  async function requestLocationPermission() {
    try {
      setLocationLoading(true);
      const permission = await requestForegroundPermissions();
      
      if (permission.status === 'granted') {
        const loc = await getCurrentPosition();
        setLocation(loc);
        console.log('üìç [Checkout] Localiza√ß√£o obtida:', loc.coords);
      } else {
        Alert.alert(
          'Permiss√£o necess√°ria',
          '√â necess√°rio permitir o acesso √† localiza√ß√£o para fazer checkout.',
          [
            { text: 'Cancelar', style: 'cancel' },
            { text: 'Tentar novamente', onPress: requestLocationPermission },
          ]
        );
      }
    } catch (error: any) {
      console.error('‚ùå [Checkout] Erro ao solicitar permiss√£o de localiza√ß√£o:', error);
      Alert.alert('Erro', error?.message || 'N√£o foi poss√≠vel solicitar permiss√£o de localiza√ß√£o');
    } finally {
      setLocationLoading(false);
    }
  }

  // Fun√ß√£o para atualizar localiza√ß√£o (pode ser chamada a qualquer momento)
  async function updateLocation(): Promise<LocationObject | null> {
    try {
      setLocationLoading(true);
      console.log('üìç [Checkout] Atualizando localiza√ß√£o...');
      
      // Verificar permiss√£o primeiro
      const permission = await requestForegroundPermissions();
      
      if (permission.status !== 'granted') {
        console.warn('‚ö†Ô∏è [Checkout] Permiss√£o de localiza√ß√£o n√£o concedida');
        setLocationLoading(false);
        return null;
      }

      // Obter localiza√ß√£o atualizada
      const loc = await getCurrentPosition({
        accuracy: 6, // Alta precis√£o
        maximumAge: 10000, // Aceitar localiza√ß√£o com at√© 10 segundos
        timeout: 15000, // Timeout de 15 segundos
      });
      
      setLocation(loc);
      console.log('‚úÖ [Checkout] Localiza√ß√£o atualizada:', loc.coords);
      setLocationLoading(false);
      return loc;
    } catch (error: any) {
      console.error('‚ùå [Checkout] Erro ao atualizar localiza√ß√£o:', error);
      setLocationLoading(false);
      return null;
    }
  }

  async function requestCameraPermission() {
    try {
      const { status } = await ImagePicker.requestCameraPermissionsAsync();
      setCameraPermission(status === 'granted');
    } catch (error) {
      console.error('Erro ao solicitar permiss√£o de c√¢mera:', error);
      setCameraPermission(false);
    }
  }

  async function takePhoto() {
    try {
      if (cameraPermission === false) {
        const { status } = await ImagePicker.requestCameraPermissionsAsync();
        setCameraPermission(status === 'granted');
        if (status !== 'granted') {
          Alert.alert('Permiss√£o necess√°ria', '√â necess√°rio permitir o acesso √† c√¢mera');
          return;
        }
      }

      const result = await ImagePicker.launchCameraAsync({
        mediaTypes: ImagePicker.MediaTypeOptions.Images,
        quality: 0.8,
        allowsEditing: false,
      });

      if (!result.canceled && result.assets[0]) {
        setPhotoUri(result.assets[0].uri);
        setShowPreview(true);
        
        // Atualizar localiza√ß√£o ap√≥s tirar a foto
        console.log('üì∏ [Checkout] Foto capturada, atualizando localiza√ß√£o...');
        await updateLocation();
      }
    } catch (error) {
      console.error('‚ùå [Checkout] Erro ao capturar foto:', error);
      Alert.alert('Erro', 'N√£o foi poss√≠vel capturar a foto');
    }
  }

  // Fun√ß√£o auxiliar para prosseguir com o checkout ap√≥s valida√ß√µes
  async function proceedWithCheckout(currentLocation: LocationObject) {
    setLoading(true);
    try {
      console.log('üì∏ [Checkout] Iniciando processo de checkout...');
      console.log('üì∏ [Checkout] Visit ID:', visit!.id);
      console.log('üì∏ [Checkout] Location:', currentLocation.coords);
      console.log('üì∏ [Checkout] Photo URI:', photoUri);

      // 1. Obter presigned URL para upload da foto
      console.log('üì∏ [Checkout] Obtendo presigned URL...');
      const { presignedUrl, url } = await photoService.getPresignedUrl({
        visitId: visit!.id,
        type: 'FACADE_CHECKOUT',
        contentType: 'image/jpeg',
        extension: 'jpg',
      });

      console.log('üì∏ [Checkout] Presigned URL obtida:', presignedUrl ? 'Sim' : 'N√£o');
      console.log('üì∏ [Checkout] URL final:', url);

      // 2. Upload da foto para Firebase Storage
      if (photoUri && presignedUrl) {
        try {
          console.log('üì∏ [Checkout] Fazendo upload da foto...');
          const uploadSuccess = await photoService.uploadToFirebase(presignedUrl, photoUri, 'image/jpeg');
          
          if (!uploadSuccess) {
            console.warn('‚ö†Ô∏è [Checkout] Upload da foto falhou, mas continuando com checkout...');
          } else {
            console.log('‚úÖ [Checkout] Upload da foto conclu√≠do com sucesso');
          }
        } catch (uploadError: any) {
          console.error('‚ùå [Checkout] Erro no upload da foto:', uploadError);
          console.error('‚ùå [Checkout] Mensagem:', uploadError?.message);
          console.warn('‚ö†Ô∏è [Checkout] Continuando checkout sem confirma√ß√£o de upload...');
        }
      } else {
        console.warn('‚ö†Ô∏è [Checkout] Presigned URL ou photoUri n√£o dispon√≠vel');
      }

      // 3. Fazer checkout
      console.log('üì∏ [Checkout] Enviando requisi√ß√£o de checkout...');
      const result = await visitService.checkOut({
        visitId: visit!.id,
        latitude: currentLocation.coords.latitude,
        longitude: currentLocation.coords.longitude,
        photoUrl: url,
      });

      console.log('‚úÖ [Checkout] Checkout realizado com sucesso:', result);

      const hoursWorked = result.visit?.hoursWorked || '0.00';
      Alert.alert(
        '‚úÖ Sucesso',
        `Checkout realizado com sucesso!\n\nHoras trabalhadas: ${hoursWorked}h`,
        [
          {
            text: 'OK',
            onPress: () => navigation.navigate('Home'),
          },
        ]
      );
    } catch (error: any) {
      console.error('‚ùå [Checkout] Erro no checkout:', error);
      console.error('‚ùå [Checkout] Response:', error?.response?.data);
      Alert.alert('Erro', error?.response?.data?.message || 'N√£o foi poss√≠vel fazer checkout');
    } finally {
      setLoading(false);
    }
  }

  async function handleCheckout() {
    if (!visit) {
      Alert.alert('Erro', 'Visita n√£o encontrada');
      return;
    }

    if (!photoUri) {
      Alert.alert('Erro', 'Tire uma foto da fachada primeiro');
      return;
    }

    // Tentar obter localiza√ß√£o se n√£o estiver dispon√≠vel
    let currentLocation = location;
    if (!currentLocation) {
      console.log('üìç [Checkout] Localiza√ß√£o n√£o dispon√≠vel, tentando obter...');
      const updatedLocation = await updateLocation();
      if (!updatedLocation) {
        Alert.alert(
          'Localiza√ß√£o necess√°ria',
          'N√£o foi poss√≠vel obter a localiza√ß√£o. Por favor, verifique as permiss√µes e tente novamente.',
          [
            { text: 'Cancelar', style: 'cancel' },
            { text: 'Tentar novamente', onPress: async () => {
              const retryLocation = await updateLocation();
              if (retryLocation) {
                handleCheckout();
              }
            }},
          ]
        );
        return;
      }
      currentLocation = updatedLocation;
    }

    if (!currentLocation) {
      Alert.alert('Erro', 'N√£o foi poss√≠vel obter a localiza√ß√£o');
      return;
    }

    // Verificar cobertura de ind√∫strias antes do checkout
    try {
      console.log('üì¶ [Checkout] Verificando cobertura de ind√∫strias...');
      const coverage = await industryService.getVisitCoverage(visit.id);
      
      if (!coverage.isComplete && coverage.pending.length > 0) {
        const pendingNames = coverage.pending.map(p => p.industry.name).join(', ');
        const percentComplete = coverage.percentComplete;
        
        Alert.alert(
          '‚ö†Ô∏è Ind√∫strias Pendentes',
          `Esta loja requer fotos de ${coverage.totalRequired} ind√∫strias.\n\n` +
          `Voc√™ cobriu ${coverage.totalCovered} de ${coverage.totalRequired} (${percentComplete}%).\n\n` +
          `Faltam: ${pendingNames}`,
          [
            { 
              text: 'Voltar e completar', 
              style: 'cancel',
              onPress: () => navigation.goBack(),
            },
            { 
              text: 'Checkout mesmo assim', 
              style: 'destructive',
              onPress: () => proceedWithCheckout(currentLocation!),
            },
          ]
        );
        return;
      }
      
      console.log('‚úÖ [Checkout] Cobertura completa, prosseguindo...');
    } catch (error) {
      // Se falhar a verifica√ß√£o de cobertura, continuar com checkout
      console.warn('‚ö†Ô∏è [Checkout] Erro ao verificar cobertura, prosseguindo:', error);
    }

    // Prosseguir com checkout
    proceedWithCheckout(currentLocation);
  }

  function calculateDuration() {
    if (!checkInTime) return '0h';
    const now = new Date();
    const diff = now.getTime() - checkInTime.getTime();
    const hours = (diff / (1000 * 60 * 60)).toFixed(2);
    return `${hours}h`;
  }

  if (!visit) {
    return (
      <View style={styles.container}>
        <Card style={styles.errorCard}>
          <Text style={styles.errorIcon}>‚ö†Ô∏è</Text>
          <Text style={styles.errorTitle}>Visita n√£o encontrada</Text>
          <Text style={styles.errorText}>
            N√£o foi poss√≠vel encontrar a visita ativa. Tente novamente.
          </Text>
          <Button
            variant="primary"
            size="md"
            onPress={() => navigation.navigate('Home')}
            style={styles.errorButton}
          >
            Voltar ao In√≠cio
          </Button>
        </Card>
      </View>
    );
  }

  if (cameraPermission === null) {
    return (
      <View style={styles.container}>
        <ActivityIndicator size="large" color={colors.primary[600]} />
      </View>
    );
  }

  if (cameraPermission === false) {
    return (
      <View style={styles.container}>
        <Card style={styles.permissionCard}>
          <Text style={styles.permissionIcon}>üì∑</Text>
          <Text style={styles.permissionTitle}>Permiss√£o de C√¢mera Necess√°ria</Text>
          <Text style={styles.permissionText}>
            Precisamos do acesso √† c√¢mera para tirar fotos da fachada das lojas.
          </Text>
          <Button variant="primary" size="lg" onPress={requestCameraPermission} style={styles.permissionButton}>
            Permitir C√¢mera
          </Button>
        </Card>
      </View>
    );
  }

  return (
    <ScrollView style={styles.container} contentContainerStyle={styles.contentContainer}>
      {/* Header */}
      <View style={styles.header}>
        <Text style={styles.title}>Checkout</Text>
        <Text style={styles.subtitle}>Finalize sua visita</Text>
      </View>

      {/* Informa√ß√µes da Visita */}
      <Card style={styles.visitCard} shadow>
        <View style={styles.visitHeader}>
          <View style={styles.visitIcon}>
            <Text style={styles.visitIconText}>üè™</Text>
          </View>
          <View style={styles.visitInfo}>
            <Text style={styles.visitStoreName}>{visit.store.name}</Text>
            <Text style={styles.visitStoreAddress}>{visit.store.address}</Text>
          </View>
        </View>
        {checkInTime && (
          <View style={styles.visitDuration}>
            <View style={styles.durationItem}>
              <Text style={styles.durationLabel}>Check-in</Text>
              <Text style={styles.durationValue}>
                {checkInTime.toLocaleTimeString('pt-BR', {
                  hour: '2-digit',
                  minute: '2-digit',
                })}
              </Text>
            </View>
            <View style={styles.durationItem}>
              <Text style={styles.durationLabel}>Dura√ß√£o</Text>
              <Text style={[styles.durationValue, styles.durationValueHighlight]}>
                {calculateDuration()}
              </Text>
            </View>
          </View>
        )}
      </Card>

      {/* Preview da Foto ou C√¢mera */}
      {showPreview && photoUri ? (
        <Card style={styles.previewCard} shadow>
          <View style={styles.previewHeader}>
            <Text style={styles.previewTitle}>Preview da Foto</Text>
            <TouchableOpacity
              onPress={() => {
                setPhotoUri(null);
                setShowPreview(false);
              }}
              style={styles.closeButton}
            >
              <Text style={styles.closeButtonText}>‚úï</Text>
            </TouchableOpacity>
          </View>
          <Image source={{ uri: photoUri }} style={styles.previewImage} />
          <View style={styles.previewActions}>
            <Button
              variant="outline"
              size="md"
              onPress={() => {
                setPhotoUri(null);
                setShowPreview(false);
              }}
              style={styles.previewButton}
            >
              Tirar Outra
            </Button>
          </View>
        </Card>
      ) : (
        <Card style={styles.cameraCard} shadow>
          <View style={styles.cameraPlaceholder}>
            <Text style={styles.cameraIcon}>üì∑</Text>
            <Text style={styles.cameraText}>Pronto para tirar foto</Text>
          </View>
        </Card>
      )}

      {/* Status */}
      <Card style={styles.statusCard} shadow>
        <View style={styles.statusRow}>
          <View style={styles.statusItem}>
            <View
              style={[
                styles.statusIndicator,
                location ? styles.statusIndicatorActive : undefined,
              ]}
            >
              <Text style={styles.statusIcon}>{location ? '‚úì' : '‚óã'}</Text>
            </View>
            <View style={styles.statusInfo}>
              <Text style={styles.statusLabel}>Localiza√ß√£o</Text>
              <Text style={styles.statusValue}>
                {locationLoading ? 'Obtendo...' : location ? 'Obtida' : 'Pendente'}
              </Text>
            </View>
          </View>
          <View style={styles.statusItem}>
            <View
              style={[
                styles.statusIndicator,
                photoUri ? styles.statusIndicatorActive : undefined,
              ]}
            >
              <Text style={styles.statusIcon}>{photoUri ? '‚úì' : '‚óã'}</Text>
            </View>
            <View style={styles.statusInfo}>
              <Text style={styles.statusLabel}>Foto</Text>
              <Text style={styles.statusValue}>{photoUri ? 'Capturada' : 'Pendente'}</Text>
            </View>
          </View>
        </View>
      </Card>

      {/* A√ß√µes */}
      <View style={styles.actions}>
        {!showPreview && (
          <Button
            variant="accent"
            size="lg"
            onPress={takePhoto}
            disabled={loading}
            style={styles.actionButton}
          >
            üì∑ Tirar Foto
          </Button>
        )}
        <Button
          variant="primary"
          size="lg"
          onPress={handleCheckout}
          isLoading={loading}
          disabled={!photoUri || !location || loading}
          style={styles.actionButton}
        >
          ‚úÖ Finalizar Checkout
        </Button>
      </View>
    </ScrollView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: colors.dark.background,
  },
  contentContainer: {
    padding: theme.spacing.lg,
  },
  header: {
    marginBottom: theme.spacing.xl,
  },
  title: {
    fontSize: theme.typography.fontSize['3xl'],
    fontWeight: theme.typography.fontWeight.bold,
    color: colors.text.primary,
    marginBottom: theme.spacing.xs,
  },
  subtitle: {
    fontSize: theme.typography.fontSize.base,
    color: colors.text.secondary,
  },
  visitCard: {
    marginBottom: theme.spacing.lg,
  },
  visitHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: theme.spacing.md,
  },
  visitIcon: {
    width: 50,
    height: 50,
    borderRadius: theme.borderRadius.full,
    backgroundColor: colors.primary[100],
    justifyContent: 'center',
    alignItems: 'center',
    marginRight: theme.spacing.md,
  },
  visitIconText: {
    fontSize: 24,
  },
  visitInfo: {
    flex: 1,
  },
  visitStoreName: {
    fontSize: theme.typography.fontSize.lg,
    fontWeight: theme.typography.fontWeight.bold,
    color: colors.text.primary,
    marginBottom: theme.spacing.xs,
  },
  visitStoreAddress: {
    fontSize: theme.typography.fontSize.sm,
    color: colors.text.secondary,
  },
  visitDuration: {
    flexDirection: 'row',
    paddingTop: theme.spacing.md,
    borderTopWidth: 1,
    borderTopColor: colors.dark.border,
    gap: theme.spacing.lg,
  },
  durationItem: {
    flex: 1,
  },
  durationLabel: {
    fontSize: theme.typography.fontSize.xs,
    color: colors.text.tertiary,
    marginBottom: theme.spacing.xs,
    textTransform: 'uppercase',
    letterSpacing: 0.5,
  },
  durationValue: {
    fontSize: theme.typography.fontSize.base,
    fontWeight: theme.typography.fontWeight.medium,
    color: colors.text.primary,
  },
  durationValueHighlight: {
    color: colors.primary[600],
    fontWeight: theme.typography.fontWeight.bold,
  },
  cameraCard: {
    marginBottom: theme.spacing.lg,
    minHeight: 200,
  },
  cameraPlaceholder: {
    height: 200,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: colors.dark.card,
    borderRadius: theme.borderRadius.lg,
  },
  cameraIcon: {
    fontSize: 48,
    marginBottom: theme.spacing.md,
  },
  cameraText: {
    fontSize: theme.typography.fontSize.base,
    color: colors.text.secondary,
  },
  previewCard: {
    marginBottom: theme.spacing.lg,
  },
  previewHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: theme.spacing.md,
  },
  previewTitle: {
    fontSize: theme.typography.fontSize.lg,
    fontWeight: theme.typography.fontWeight.bold,
    color: colors.text.primary,
  },
  closeButton: {
    width: 32,
    height: 32,
    borderRadius: theme.borderRadius.full,
    backgroundColor: colors.dark.card,
    justifyContent: 'center',
    alignItems: 'center',
  },
  closeButtonText: {
    fontSize: 18,
    color: colors.text.secondary,
  },
  previewImage: {
    width: '100%',
    height: 300,
    borderRadius: theme.borderRadius.lg,
    marginBottom: theme.spacing.md,
  },
  previewActions: {
    flexDirection: 'row',
    gap: theme.spacing.md,
  },
  previewButton: {
    flex: 1,
  },
  statusCard: {
    marginBottom: theme.spacing.lg,
  },
  statusRow: {
    gap: theme.spacing.md,
  },
  statusItem: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  statusIndicator: {
    width: 40,
    height: 40,
    borderRadius: theme.borderRadius.full,
    backgroundColor: colors.dark.card,
    justifyContent: 'center',
    alignItems: 'center',
    marginRight: theme.spacing.md,
  },
  statusIndicatorActive: {
    backgroundColor: '#22c55e20',
  },
  statusIcon: {
    fontSize: 20,
    fontWeight: theme.typography.fontWeight.bold,
  },
  statusInfo: {
    flex: 1,
  },
  statusLabel: {
    fontSize: theme.typography.fontSize.xs,
    color: colors.text.tertiary,
    marginBottom: theme.spacing.xs,
    textTransform: 'uppercase',
    letterSpacing: 0.5,
  },
  statusValue: {
    fontSize: theme.typography.fontSize.sm,
    fontWeight: theme.typography.fontWeight.medium,
    color: colors.text.primary,
  },
  actions: {
    gap: theme.spacing.md,
    marginTop: theme.spacing.md,
  },
  actionButton: {
    width: '100%',
  },
  permissionCard: {
    margin: theme.spacing.xl,
    alignItems: 'center',
    padding: theme.spacing.xl,
  },
  permissionIcon: {
    fontSize: 64,
    marginBottom: theme.spacing.lg,
  },
  permissionTitle: {
    fontSize: theme.typography.fontSize['2xl'],
    fontWeight: theme.typography.fontWeight.bold,
    color: colors.text.primary,
    marginBottom: theme.spacing.md,
    textAlign: 'center',
  },
  permissionText: {
    fontSize: theme.typography.fontSize.base,
    color: colors.text.secondary,
    textAlign: 'center',
    marginBottom: theme.spacing.xl,
    lineHeight: 22,
  },
  permissionButton: {
    width: '100%',
  },
  errorCard: {
    margin: theme.spacing.xl,
    alignItems: 'center',
    padding: theme.spacing.xl,
  },
  errorIcon: {
    fontSize: 64,
    marginBottom: theme.spacing.lg,
  },
  errorTitle: {
    fontSize: theme.typography.fontSize['2xl'],
    fontWeight: theme.typography.fontWeight.bold,
    color: colors.text.primary,
    marginBottom: theme.spacing.md,
    textAlign: 'center',
  },
  errorText: {
    fontSize: theme.typography.fontSize.base,
    color: colors.text.secondary,
    textAlign: 'center',
    marginBottom: theme.spacing.xl,
    lineHeight: 22,
  },
  errorButton: {
    width: '100%',
  },
});
